<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tech Tree Proof of Concept</title>
  <script type="text/javascript" src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  <link href="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.css" rel="stylesheet" />  <style>
    #network {
      width: 100vw;
      height: 90vh;
      border: 1px solid #333;
      background: #1a1a1a;
      cursor: pointer;
    }
    body { 
      font-family: sans-serif; 
      background: #222; 
      color: #fff; 
      margin: 0;
    }
    h2 { color: #fff; margin: 10px; }
    .controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
    }
    .controls button {
      background: #444;
      color: #fff;
      border: 1px solid #666;
      padding: 5px 10px;
      margin: 2px;
      border-radius: 3px;
      cursor: pointer;
    }    .controls button:hover {
      background: #555;
    }
    .progress-bar {
      position: absolute;
      top: 70px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      min-width: 200px;
    }
    .progress-fill {
      background: linear-gradient(90deg, #4CAF50, #45a049);
      height: 20px;
      border-radius: 10px;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 11px;
    }
    .progress-bg {
      background: #333;
      height: 20px;
      border-radius: 10px;
      margin: 5px 0;
    }
    .legend {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 5px;
      font-size: 11px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 3px 0;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      margin-right: 8px;
      border: 1px solid #666;
    }
  </style>
</head>
<body>
  <h2>Tech Tree Proof of Concept</h2>  <div class="controls">
    <button id="expandAll">Expand All</button>
    <button id="collapseAll">Collapse All</button>
    <button id="resetProgress">Reset Progress</button>
    <div id="statusInfo" style="margin-top: 5px; font-size: 10px;">
      Click category/subcategory labels to expand/collapse
    </div>
  </div>
  
  <div class="progress-bar">
    <div style="margin-bottom: 5px;">Progress</div>
    <div class="progress-bg">
      <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
    </div>
    <div id="progressText">0/0 courses completed</div>
  </div>
  
  <div class="legend">
    <div style="margin-bottom: 5px; font-weight: bold;">Legend</div>
    <div class="legend-item">
      <div class="legend-color" style="background: linear-gradient(135deg, #4CAF50, #45a049);"></div>
      <span>Selected</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: linear-gradient(135deg, #2196F3, #1976D2);"></div>
      <span>Available</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: linear-gradient(135deg, #3f51b5, #303f9f);"></div>
      <span>Optional</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #2a2a2a; opacity: 0.6;"></div>
      <span>Locked</span>
    </div>
  </div>
  
  <div id="network"></div><script type="module">
    import { buildSkillTreeGraph, loadPrereqs } from './js/DegreePlan/Graph/SkillTreeGraphBuilder.js';

    let degreePlan, prereqs, network, collapsedState = {}, categoryInfo = {}, nodeStates = {};

    async function loadDegreePlan(url) {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('Failed to load degree plan');
      return await resp.json();
    }    function updateNetwork() {
      // Show loading indicator
      const networkDiv = document.getElementById('network');
      const loadingOverlay = document.createElement('div');
      loadingOverlay.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        z-index: 1000;
      `;      loadingOverlay.textContent = 'Updating...';
      networkDiv.appendChild(loadingOverlay);

      // Save current view position
      const viewPosition = network.getViewPosition();
      const scale = network.getScale();      // Small delay to allow UI to update
      setTimeout(() => {
        const { nodes, edges, groupMap, categoryInfo: newCategoryInfo, nodeStates: newNodeStates } = buildSkillTreeGraph(degreePlan, prereqs, collapsedState, nodeStates);
        categoryInfo = newCategoryInfo;
        nodeStates = newNodeStates;
        
        const data = {
          nodes: new vis.DataSet(nodes),
          edges: new vis.DataSet(edges)
        };

        const options = {
          groups: Object.fromEntries(
            Object.entries(groupMap).map(([id, label]) => [
              id,
              {
                label,
                color: { background: "#e0e7ef", border: "#8ca0c8" },
                font: { color: "#222", size: 16 }
              }
            ])
          ),
          nodes: { font: { color: "#000", size: 14 } },
          edges: { color: "#ccc" },
          interaction: { dragNodes: true, multiselect: true },
          manipulation: { enabled: true },
          layout: { improvedLayout: false },
          physics: false
        };        network.setData(data);
        network.setOptions(options);
        
        // Restore view position
        network.moveTo({
          position: viewPosition,
          scale: scale
        });
          // Update status info and progress
        const courseCount = nodes.filter(n => n.nodeType === "course").length;
        const totalCategories = Object.keys(categoryInfo).length;
        const collapsedCount = Object.values(collapsedState).filter(Boolean).length;
        const selectedCount = Object.values(nodeStates).filter(state => state === 'selected').length;
        const totalCourses = Object.keys(nodeStates).length;
        const progressPercent = totalCourses > 0 ? Math.round((selectedCount / totalCourses) * 100) : 0;
        
        document.getElementById('statusInfo').innerHTML = `
          ${courseCount} courses visible<br>
          ${collapsedCount} items collapsed<br>
          Click labels to expand/collapse
        `;
        
        document.getElementById('progressText').textContent = `${selectedCount}/${totalCourses} courses completed`;
        const progressFill = document.getElementById('progressFill');
        progressFill.style.width = `${progressPercent}%`;
        progressFill.textContent = `${progressPercent}%`;
        
        // Remove loading overlay
        networkDiv.removeChild(loadingOverlay);
      }, 50);
    }    function handleNodeClick(event) {
      const { nodes: nodeIds } = event;
      if (nodeIds.length === 0) return;

      const nodeId = nodeIds[0];
      const node = network.body.data.nodes.get(nodeId);
      
      if (node && node.collapsible) {
        // Toggle collapsed state for categories/subcategories
        collapsedState[nodeId] = !collapsedState[nodeId];
        updateNetwork();
      } else if (node && node.nodeType === "course") {
        // Handle course node selection
        const currentState = nodeStates[nodeId] || 'unlocked';
        
        if (currentState === 'unlocked') {
          // Select the course
          nodeStates[nodeId] = 'selected';
          
          // Check if this unlocks any dependent courses
          Object.keys(nodeStates).forEach(courseId => {
            if (nodeStates[courseId] === 'locked') {
              // Check if all prerequisites are now satisfied
              // This is a simplified check - in a real app you'd check the actual prereq data
              nodeStates[courseId] = 'unlocked';
            }
          });
          
        } else if (currentState === 'selected') {
          // Deselect the course
          nodeStates[nodeId] = 'unlocked';
        }
        // locked courses can't be clicked
        
        updateNetwork();
      }
    }

    function expandAll() {
      collapsedState = {};
      updateNetwork();
    }    function collapseAll() {
      // Get all category and subcategory node IDs
      const allNodes = network.body.data.nodes.get();
      allNodes.forEach(node => {
        if (node.collapsible) {
          collapsedState[node.id] = true;
        }
      });
      updateNetwork();
    }

    function resetProgress() {
      // Reset all courses to their initial state
      Object.keys(nodeStates).forEach(courseId => {
        nodeStates[courseId] = 'unlocked'; // or determine based on prerequisites
      });
      updateNetwork();
    }

    async function main() {
      const networkDiv = document.getElementById('network');
      networkDiv.innerHTML = 'Loading...';
      
      try {
        // Load data
        [degreePlan, prereqs] = await Promise.all([
          loadDegreePlan('./DegreeJSON/5040.json'),
          loadPrereqs('./DegreeJSON/202510_Pre26CoReqs.json')
        ]);

        // Create initial network
        networkDiv.innerHTML = '';
        network = new vis.Network(networkDiv, { nodes: [], edges: [] }, {});
          // Set up click event handler
        network.on('click', handleNodeClick);
          // Set up button event handlers
        document.getElementById('expandAll').addEventListener('click', expandAll);
        document.getElementById('collapseAll').addEventListener('click', collapseAll);
        document.getElementById('resetProgress').addEventListener('click', resetProgress);
        
        // Initial render
        updateNetwork();
        
      } catch (err) {
        networkDiv.innerHTML = `<div style='color:red'>${err.message}</div>`;
      }
    }

    main();
  </script>
</body>
</html>
